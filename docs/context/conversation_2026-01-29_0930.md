# Context Snapshot - Privacy-Preserving Devnet Swap
**Date:** 2026-01-29 09:30

## Completed: Relayer-Based Raydium Swap for True Privacy

**Problem:** Previous devnet swap flow broke privacy:
```
Pool → Relayer → USER'S WALLET → Raydium → Recipient
                      ↑
               PRIVACY LEAK (user signs swap)
```

**Solution Implemented:** Mirror mainnet Jupiter architecture:
```
Pool → Relayer → RELAYER WALLET → Raydium → Recipient
                      ↑
           Relayer signs EVERYTHING
           User's wallet never in chain
```

## Changes Made

### Phase 1: `backend/services/raydium_service.py` (NEW)
- Created Raydium API service for devnet
- `get_quote()` - Fetches swap quotes
- `get_swap_transaction()` - Builds tx with `wallet=relayer`, `outputAccount=recipient_ata`
- `_derive_ata()` - Derives Associated Token Account for recipient

### Phase 2: `backend/api/routes/swap.py` (MODIFIED)
- Added `/swap/execute-devnet` endpoint
- Flow: validate proof → get quote → unshield to RELAYER → relayer signs swap → tokens to recipient
- Handles partial success (unshield ok, swap failed)

### Phase 3: `frontend/lib/api.ts` (MODIFIED)
- Added `executeSwapDevnet(jobId, recipient, outputMint)` function

### Phase 4: `frontend/hooks/usePrivateSwap.ts` (MODIFIED)
- Replaced client-side Raydium calls with backend endpoint
- Removed `signTransaction`, `useConnection`, `VersionedTransaction`
- User only signs once: secret derivation
- Backend handles all swap execution

## Privacy Flow (After Fix)

1. User signs message → derives secret
2. Backend generates ZK proof
3. Backend calls `/swap/execute-devnet`:
   - Unshields SOL to **relayer's wallet**
   - Relayer signs Raydium swap
   - Tokens sent to recipient's ATA
4. User's wallet **never appears** in unshield or swap transactions

## Verification Steps

1. Shield SOL on devnet
2. Execute private swap with **different recipient address**
3. Verify on Solscan:
   - Unshield tx: Pool → Relayer (not user!)
   - Swap tx: Relayer signs, tokens go to recipient
   - **User's wallet never appears in either transaction**

## Files Modified

| File | Action |
|------|--------|
| `backend/services/raydium_service.py` | Created |
| `backend/api/routes/swap.py` | Added `/execute-devnet` |
| `frontend/lib/api.ts` | Added `executeSwapDevnet` |
| `frontend/hooks/usePrivateSwap.ts` | Replaced client-side flow |
