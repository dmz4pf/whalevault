# Context Snapshot - WhaleVault Privacy Vault
**Date:** 2026-01-27 08:30
**Context Usage:** High

## Current Task
Fix shielding broken after v2 denomination/fixed deposit changes.

## Root Cause
- On-chain program was NOT redeployed with v2 code
- Old program used seed `b"privacy_pool"` (no denomination), new code uses `b"pool"` + denomination bytes
- PDA mismatch caused `AccountNotInitialized` error

## Resolution
1. Deployed NEW program to devnet: `3qhVPvz8T1WiozCLEfhUuv8WZHDPpEfnAzq2iSatULc7`
   - Old program: `F3NLgP6kebPXSbH2GxGF39cR6uVdbzFD1V7iTgg7Htp4` (keypair lost, cannot upgrade)
   - Used Alchemy devnet RPC for deployment (public RPC rate-limited)
   - Alchemy key: `XKYOAeu10iSorSwkdhh3c` (devnet URL: `https://solana-devnet.g.alchemy.com/v2/XKYOAeu10iSorSwkdhh3c`)

2. Initialized all 4 denomination pools on-chain:
   - Custom (denom=0): `E15eMJWakj5Dgr9RG6R4tXUQcFCGJxGZFqCs6AaWEWnJ`
   - 0.1 SOL: `B5Bfim58CuDwrBg447ytDy1ZAggcKQp7xqJvdFnwgfVo`
   - 1 SOL: `3xJa2TXi299TKzscsg7qrFr1NStjHgQuDABQpbvYSefD`
   - 10 SOL: `GXjbikAuWUNWKDDDYMHKx5bchGoJLPUmaKmoR3Ugj2qp`

3. Updated program ID in all config:
   - `backend/.env`
   - `backend/config.py`
   - `frontend/lib/constants.ts`
   - `veil/Anchor.toml`
   - `veil/crates/program/src/lib.rs` (declare_id!)

4. Restored v2 PDA derivation (seed=`b"pool"` + denomination LE bytes) in:
   - `backend/services/veil_service.py`
   - `backend/services/pool_service.py`
   - `veil/src/veil/solana_client.py`

5. Added `idl-build` feature to `veil/crates/program/Cargo.toml`

## Key Decisions
- Deployed as new program since original keypair was lost
- Used Alchemy devnet RPC to bypass public RPC rate limiting
- Created `scripts/init_pools.py` for pool initialization

## Files Modified
- `veil/crates/program/src/lib.rs` - declare_id updated
- `veil/crates/program/Cargo.toml` - added idl-build feature
- `veil/Anchor.toml` - program ID updated
- `backend/.env` - PROGRAM_ID updated
- `backend/config.py` - default program ID updated
- `backend/services/veil_service.py` - PDA seeds restored to v2
- `backend/services/pool_service.py` - PDA seeds restored to v2
- `veil/src/veil/solana_client.py` - PDA seeds restored to v2
- `frontend/lib/constants.ts` - program ID updated
- `scripts/init_pools.py` - NEW: pool initialization script

## Next Steps
- Test shielding from frontend (should work now)
- Test unshielding
- Stack size warning in build (non-fatal but should fix groth16 module)
- Deploy IDL to new program (failed during initial deploy)

## Blockers
- None currently. Program deployed, pools initialized, config updated.
