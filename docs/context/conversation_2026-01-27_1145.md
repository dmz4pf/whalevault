# Context Snapshot - WhaleVault V3 PRD/Architecture Updates
**Date:** 2026-01-27 11:45

## Current Task
Updating PRD and architecture docs to reflect V2+V3 changes. PRD update started — executive summary section done. Need to continue with remaining PRD sections and full architecture doc update.

## What's Been Done So Far
1. V3 implementation plan written: `docs/plans/2026-01-27-v3-implementation-plan.md`
2. PRD Section 1 (Executive Summary) updated — solution description and success metrics now include Private Swap, Supabase, Stealth Withdraw, privacy delays
3. PRD needs remaining sections updated (2-10)
4. Architecture doc needs full update

## PRD Sections Still Needing Updates

### Section 2.1 Core User Flow
- Update diagram: add Private Swap path, rename Unshield → Stealth Withdraw

### Section 2.2 Core Features
- Add: Private Swap, Encrypted Cloud Backup, Privacy Delays, Deposit Receipts, Transaction History
- Update: Unshield → Stealth Withdraw

### Section 2.3 What We're NOT Building
- Remove: "SPL token support" (Private Swap covers output tokens)
- Remove: "Relayer network" (V2 added relayer)
- Keep: Private transfers between users, mobile app, multi-sig

### Section 3.1 System Architecture diagram
- Add Supabase, Jupiter API, Relayer to the diagram

### Section 3.2 Technology Stack
- Add: Supabase (encrypted position storage), Jupiter API (token swaps), AES-256-GCM (client-side encryption)

### Section 3.3 Data Flow
- Update unshield flow to show relayer
- Add Private Swap flow

### Section 3.4 API Endpoints
- Add: /api/swap/quote, /api/swap/execute, /api/relay/info, /api/relay/unshield

### Section 4.1 Screen Flow
- Add Private Swap page, rename Unshield → Stealth Withdraw
- Update nav: Dashboard | Shield | Stealth Withdraw | Private Swap | History

### Section 4.2 Screen Details
- Add Screen for Private Swap
- Update Unshield → Stealth Withdraw with privacy delay toggle
- Update History with export/import

### Section 5.3 Frontend Security
- Update: secrets encrypted via AES-256-GCM in Supabase
- Add: wallet signature auth, wallet_hash (SHA-256) for lookup

### Section 9 Deliverables
- Move "Multiple token support" from Nice to Have to Required (via Private Swap)
- Add Supabase setup to required

## Architecture Doc Updates Needed
1. Section 2.3 Assumptions — remove A5 (single pool), update A6 (Supabase replaces localStorage)
2. Section 3.3 Endpoints — add swap + relay endpoints
3. Section 4.1 Frontend State — add useVaultStorage, usePrivateSwap stores
4. Section 4.2 Backend Models — add swap request/response models
5. Section 8.1 Infrastructure — add Supabase to deployment diagram
6. Section 8.2 Environment Variables — add SUPABASE_URL, SUPABASE_ANON_KEY, JUPITER_API_URL
7. Section 9 File Structure — add new files for swap, supabase, encryption, history

## All V3 Design Decisions (Reference)
- Auth: wallet signature (sign message → session)
- Secrets: client-side AES-256-GCM, key from SHA-256(wallet signature of "WhaleVault-v1")
- Supabase schema: vault_data(wallet_hash, encrypted_data, nonce, updated_at)
- wallet_hash = SHA-256(wallet pubkey) — not reversible
- Private Swap: own page /private-swap, any token via Jupiter, relayer-side swap
- Nav: Dashboard | Shield | Stealth Withdraw | Private Swap | History
- Privacy delay: opt-in toggle, presets 1h/6h/24h, client-side enforcement
- SPL shielding: SOL-only for V3, USDC "Coming Soon" badge
- UI polish: deferred to V3.1, but included in PRD/architecture
