# Context Snapshot - WhaleVault Privacy Vault
**Date:** 2026-01-27 20:50
**Context Usage:** 100%+ (needs new session)

## Current State
All 17 V3 tasks are implemented and reviewed. User is now testing features live.

## Bugs Fixed This Session
1. **Duplicate USDC card** — Removed USDC from `SUPPORTED_TOKENS` in `frontend/lib/constants.ts` (line 71-77 deleted). Only "Coming Soon" badge remains.
2. **Repeated signature popups** — `useWallet.ts` cloud sync init was re-triggering due to `signMessage` ref instability. Fixed by using `useRef(false)` boolean guard instead of string comparison. File: `frontend/hooks/useWallet.ts:64-80`.
3. **Supabase 406 error** — Non-critical. Happens when no cloud data exists yet for wallet. Code handles it gracefully (returns null).

## Servers Running
- Frontend: `http://localhost:3000` (Next.js 14, background task b985b90)
- Backend: `http://127.0.0.1:8000` (FastAPI/uvicorn, background task b799a2f, using `backend/venv/bin/uvicorn`)

## Major Discovery: Jupiter API is Mainnet-Only
- Jupiter swap API (`api.jup.ag`) does NOT work on Solana devnet
- All swap quote calls return 502 (Bad Gateway) on devnet
- This breaks the entire Private Swap feature on devnet

## Next Feature: Dual-DEX Swap Architecture
User wants:
1. **Raydium integration for devnet** — Working swaps on devnet for testing/demo
2. **Jupiter integration for mainnet** — Best liquidity and token coverage for production
3. **Searchable token selector** — NOT static buttons. Should have:
   - Search input with dropdown
   - First 5 featured tokens as suggestions (USDC, USDT, BONK, JUP, WIF)
   - Live price data for tokens
   - Search by token name OR contract address
   - Full Jupiter/Raydium token list
4. **Network-aware messaging** — Tell users devnet has limited swap support, mainnet is better
5. **PRD and architecture docs need updating** for this change

### Architecture Decision
- Use Raydium SDK for devnet swaps
- Use Jupiter API for mainnet swaps
- Abstract behind a common `SwapService` interface
- Frontend token selector queries appropriate API based on network

## Files Modified This Session
- `frontend/lib/constants.ts` — Removed USDC from SUPPORTED_TOKENS
- `frontend/hooks/useWallet.ts` — Fixed cloud sync signature loop (useRef boolean guard)
- `frontend/.env.local` — Added real Supabase credentials
- `~/.claude/CLAUDE.md` — Added Discovery Interview Protocol

## What User Has Set Up
- Supabase project: `spxwryqmcdwkkskgnups.supabase.co`
- Supabase anon key configured in `.env.local`
- Migration `001_vault_data.sql` executed
- Phantom wallet connected on devnet with ~3.27 SOL
- Has one existing 0.1 SOL shielded position from 1/26/2026

## Next Steps (New Session)
1. Run Discovery Interview for dual-DEX swap feature
2. Create focused implementation plan
3. Update PRD + architecture docs
4. Implement Raydium devnet integration
5. Build searchable token selector UI
6. Add network-aware swap routing
7. Continue V3 feature verification
