# Context Snapshot - WhaleVault V3 Planning
**Date:** 2026-01-27 11:15
**Context Usage:** 258% (over threshold)

## Current Task
Brainstorming V3 feature design. Going through questions one at a time before writing the plan + updating PRD/architecture docs.

## Project State
- **V1**: Committed (core shield/unshield)
- **V2**: Done, uncommitted (26 modified files + 3 new — multi-pool denominations, relayer, denomination UI)
- **V3**: In design phase (this conversation)
- **V4**: Plan written at `/Users/MAC/.claude/plans/velvet-tinkering-treehouse.md` (pool seeding & anonymity UX)

## V3 Feature List (Confirmed)
1. **Supabase Integration** — encrypted cloud backup for positions/secrets
2. **SPL Token Shielding (USDC)** — SOL-only for V3, USDC "Coming Soon" badge disabled in UI
3. **Private Swap** — standalone page `/private-swap`, swap shielded SOL to any token via Jupiter, sent to any wallet
4. **Transaction History Page** — powered by Supabase data
5. **Deposit Receipt Export** — encrypted offline backup
6. **Time-Delayed Withdrawals** — opt-in toggle with presets, not enforced

## Key Design Decisions Made

### 1. Supabase Auth: Wallet Signature Auth (Option 1)
- User signs a message with Solana wallet
- Backend verifies and creates session
- Identity = wallet address, no email needed

### 2. Secret Storage: Client-side encryption (Option 1)
- Encrypt ALL data (secrets + metadata) in browser before sending to Supabase
- Encryption key derived from wallet signature of fixed message
- Supabase stores: `{ wallet_hash: SHA-256(wallet_address), encrypted_data, nonce, updated_at }`
- wallet_hash is not reversible to on-chain address
- Attacker sees: a hash, an encrypted blob, a timestamp. Nothing useful.

### 3. Token Swap Scope: Any token via Jupiter (Option 4)
- Jupiter API handles routing regardless of token
- Extra work is just UI token list + selector component
- ~100 lines additional code vs single token

### 4. Private Swap: Own page, own nav item
- `/private-swap` route — "Convert shielded SOL to any token at any address"
- Same relayer backend logic as unshield, with Jupiter swap step added
- Standalone page for marketing/pitch purposes

### 5. Nav Renaming
- Shield (stays)
- Stealth Withdraw (replaces "Unshield")
- Private Swap (new)

### 6. SPL Token Shielding: SOL-only for V3
- USDC card in UI gets "Coming Soon" badge, disabled
- Avoids splitting anonymity sets across thin pools
- Private Swap handles multi-token output without needing USDC pools

### 7. Time-Delayed Withdrawals: User picks from presets (Option 2)
- Toggle: "Enable privacy delay"
- Presets: 1 hour, 6 hours, 24 hours
- Position locked until timer expires
- Nudge text: "Recommended: delays make your withdrawal harder to trace"
- Not enforced — purely opt-in

## Brainstorming Questions Remaining
- Questions about time delay are done
- Need to continue with remaining design questions (if any)
- Then present design in sections for validation
- Then write: updated PRD, updated architecture doc, V3 implementation plan

## Files to Update
- `docs/plans/2026-01-25-whalevault-prd.md` — update from V1 to reflect V2+V3 reality
- `docs/architecture/whalevault-technical-architecture.md` — add Supabase, Jupiter, multi-token, Private Swap
- New V3 implementation plan file
- `docs/context/feasibility-report-v2-features.md` — the original feature research (already exists)

## Important Context
- Current shield page has token selector (SOL/USDC cards) and denomination selector (0.1, 1, 10, 100 SOL)
- On-chain program already supports SPL tokens
- Relayer already exists from V2 (`backend/services/relayer_service.py`)
- Feasibility report recommended Jupiter Option B (relayer-side swap)
- V3 plan was lost in a previous session — recreating from scratch
