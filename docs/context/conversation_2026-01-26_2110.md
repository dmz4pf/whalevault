# Context Snapshot - WhaleVault Privacy Vault
**Date:** 2026-01-26 21:10
**Context Usage:** High (compaction needed)

## Current Task
Completed relayer implementation for true privacy. User asking about the original "fixed deposits" plan.

## Key Decisions Made
- **Relayer model**: User's wallet never signs withdrawal tx - relayer submits on their behalf
- **Fee structure**: 0.3% (30 bps), minimum 5000 lamports
- **Relayer keypair**: `2rP2h5D28o3naqHNcND36zFkGQ5JBaouxG6fzgRjhvvC` with ~1 SOL

## Bugs Fixed Today

| Bug | Location | Root Cause | Fix |
|-----|----------|------------|-----|
| "Blockhash not found" | `veil/solana_client.py:286` | `commitment=Confirmed` returned stale blockhash | Removed commitment parameter |
| "InstructionFallbackNotFound" | `veil/solana_client.py:58-64` | Wrong Anchor discriminator bytes | Recalculated sha256("global:instruction_name") |
| "ExternalAccountLamportSpend" | `veil/crates/program/src/processor.rs:184-185` | Directly modifying lamports on system-owned PDA | Used `invoke_signed` with system program |
| User wallet 0 SOL | User's devnet wallet | No SOL on devnet | Transferred 1 SOL from relayer |

## Implementation State
- [x] Relayer keypair generated and funded
- [x] RelayerService created (`/backend/services/relayer_service.py`)
- [x] Relay API endpoints (`/api/relay/info`, `/api/relay/unshield`)
- [x] Frontend updated to use relayer (`useUnshield.ts`)
- [x] SDK discriminators fixed
- [x] Solana program redeployed with PDA transfer fix
- [x] E2E test passed - unshield works!

## Files Modified This Session
- `/backend/services/relayer_service.py` - Created
- `/backend/api/routes/relay.py` - Created
- `/backend/models/requests.py` - Added RelayUnshieldRequest
- `/backend/models/responses.py` - Added relay response types
- `/frontend/hooks/useUnshield.ts` - Rewrote to use relayer
- `/frontend/lib/api.ts` - Added relayer API functions
- `/veil/src/veil/solana_client.py` - Fixed blockhash + discriminators
- `/veil/crates/program/src/processor.rs` - Fixed PDA transfer

## Verified Working
- Shield SOL: ✅
- Proof generation: ✅
- Relayer submission: ✅
- Unshield: ✅ (tx confirmed on-chain)

## Next Steps
- Review original unshield fix plan at `/Users/MAC/.claude/plans/lucky-coalescing-duckling.md`
- User may want to continue with other items from that plan
