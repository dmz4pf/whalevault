# Context Snapshot - WhaleVault V5 Dual-DEX Swap
**Date:** 2026-01-28 06:30
**Context Usage:** 103%+

## Current Task
Fixing 5 critical issues from code review of V5 implementation.

## V5 Implementation — COMPLETE (pre-review fixes)
All 7 tasks done, typecheck passes. Files created/modified:

| File | Status |
|------|--------|
| `frontend/lib/tokens.ts` | Modified — devnet tokens (dUSDC, dUSDT), `getFeaturedTokens()` |
| `frontend/services/raydium-swap.ts` | NEW — Raydium devnet Trade API (REST, no SDK at runtime) |
| `frontend/hooks/useTokenList.ts` | NEW — network-aware token list + debounced search |
| `frontend/components/swap/TokenSelector.tsx` | NEW — searchable dropdown with chips |
| `frontend/hooks/usePrivateSwap.ts` | Modified — devnet two-step swap branch |
| `frontend/app/private-swap/page.tsx` | Modified — TokenSelector + devnet banner |
| `frontend/types/api.ts` | Modified — added optional `route` field |

## Critical Fixes Needed (from code review)
1. **raydiumResponseRef unused** — re-fetches quote during swap instead of using cached. Fix: use cached ref OR remove ref and always re-fetch (decided: use cached + fallback re-fetch)
2. **Debounce ref not cleared on unmount** — `useTokenList.ts` line 128-132, set ref to undefined after clear
3. **TokenIcon onError unsafe DOM access** — `nextElementSibling` could be null, add null check
4. **raydiumResponseRef typed as `unknown`** — needs proper type. Export `RaydiumComputeData` type from raydium-swap.ts
5. **No `res.ok` check** — raydium-swap.ts fetch calls don't check HTTP status before parsing JSON

## Key Discoveries
- V5 design doc had WRONG devnet mints:
  - dUSDC actual mint: `USDCoctVLVnvTXBEuP9s8hntucdJokbo17RwHuNXemT`
  - RAY has NO SOL pool on devnet — replaced with dUSDT (`9jWfcfEZToquBQmkoEViNSCt72veXwcvRGFQERXRjEk1`)
- Raydium Trade API (REST) works on devnet — no heavy SDK needed at runtime
  - Quote: `GET https://transaction-v1-devnet.raydium.io/compute/swap-base-in`
  - Transaction: `POST https://transaction-v1-devnet.raydium.io/transaction/swap-base-in`

## Servers
- Frontend: `cd frontend && WATCHPACK_POLLING=true npm run dev -- --turbopack`
- Backend: `cd backend && ./venv/bin/uvicorn main:app --host 127.0.0.1 --port 8000 --reload`

## Next Steps
1. Apply 5 critical fixes
2. Smoke test /private-swap page
3. Test devnet quote fetch with real wallet
