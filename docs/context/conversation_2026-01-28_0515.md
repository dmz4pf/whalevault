# Context Snapshot - WhaleVault Privacy Vault
**Date:** 2026-01-28 05:15
**Context Usage:** 700%+ (needs new session)

## V3 ‚Äî COMPLETE

All V3 features implemented and verified.

### Test Results
| # | Test | Status |
|---|------|--------|
| 1 | Connect wallet ‚Üí signs encryption message ‚Üí Supabase entry created | ‚úÖ |
| 2 | Shield SOL ‚Üí position saved to Supabase (encrypted) | ‚úÖ |
| 3 | Disconnect, reconnect ‚Üí positions load from Supabase | ‚úÖ |
| 4 | Clear localStorage ‚Üí positions still available from Supabase | ‚úÖ (proven by #3, transient HMR crash on manual test was not a real bug) |
| 5 | Stealth Withdraw with delay ‚Üí countdown shows, button disabled | ‚úÖ |
| 6 | Stealth Withdraw without delay ‚Üí works as before | ‚úÖ |
| 7 | Private Swap ‚Üí select token, see quote, confirm | ‚è≠Ô∏è Blocked (Jupiter = mainnet only, V5 fixes) |
| 8 | History page ‚Üí shows all operations with correct types/filters | ‚úÖ |
| 9 | Export receipt | üóëÔ∏è Dropped (cloud sync makes it unnecessary) |
| 10 | Import receipt | üóëÔ∏è Dropped (cloud sync makes it unnecessary) |
| 11 | USDC card on shield page ‚Üí disabled, shows "Coming Soon" | ‚úÖ |
| 12 | All pages ‚Üí smooth animations, loading states, mobile responsive | ‚úÖ |

### Note on #9/#10
The `receipt.ts` library exists with export/import functions, but no UI buttons were wired up. Decision: not needed since Supabase cloud sync handles cross-device recovery. Code can stay for future use.

## UI Change Made This Session
- **Shield page segmented control**: Replaced tiny "Use custom amount (reduced privacy) ‚Üí" text link with a pill-style segmented control: `[Fixed Pools | Custom Amount]`. Both modes have equal visual weight with icons and "Best Privacy" badge on Fixed Pools.
- Files changed: `frontend/components/shield/DenominationSelector.tsx`, `frontend/app/shield/page.tsx`

## V5 Design ‚Äî APPROVED
Saved at: `docs/plans/v5-dual-dex-swap-design.md`

### Architecture
- **Devnet:** Raydium SDK V2 on frontend (two-step: unshield SOL to wallet ‚Üí user-signed Raydium swap)
- **Mainnet:** Jupiter REST API via backend (atomic: relayer unshields + swaps in one flow)
- **Searchable token selector** replacing static 5-button grid
- **Network-aware messaging** (devnet banner about limited pairs)

### Key Decisions
- Raydium Trade API is also mainnet-only ‚Üí must use SDK V2 route swap for devnet
- Frontend-side swap chosen over Node.js sidecar (Raydium SDK is TypeScript-only)
- Two-step devnet flow accepted (unshield to wallet ‚Üí separate swap)
- Devnet tokens have different mints: dwSOL, dUSDC (mint: `BEcGFQK1T1tSu3kvHC17cyCkQ5dvXqAJ7ExB2bb5Do7a`), RAY (mint: `FSRvxBNrQWX2Fy2qvKMLL3ryEdRtE3PUTZBcdKwASZTU`)
- dwSOL/dUSDC pool has $50M TVL on devnet

### V5 Implementation Order
1. Add `@raydium-io/raydium-sdk-v2` dependency
2. Build `frontend/services/raydium-swap.ts` service
3. Build `frontend/hooks/useTokenList.ts` hook
4. Build `frontend/components/swap/TokenSelector.tsx` component
5. Update `frontend/hooks/usePrivateSwap.ts` with devnet branch
6. Update `frontend/app/private-swap/page.tsx` (TokenSelector + network banner)
7. Test devnet swap end-to-end
8. Verify mainnet path unchanged

### New Files (V5)
- `frontend/components/swap/TokenSelector.tsx`
- `frontend/hooks/useTokenList.ts`
- `frontend/services/raydium-swap.ts`

### Modified Files (V5)
- `frontend/app/private-swap/page.tsx`
- `frontend/hooks/usePrivateSwap.ts`
- `frontend/lib/tokens.ts` (add devnet featured tokens)
- `frontend/lib/api.ts` (token list fetch)
- `frontend/package.json`

## Servers
- Frontend: `cd frontend && WATCHPACK_POLLING=true npm run dev -- --turbopack`
- Backend: `cd backend && ./venv/bin/uvicorn main:app --host 127.0.0.1 --port 8000 --reload`

## User Setup
- Supabase project: `spxwryqmcdwkkskgnups.supabase.co`
- Phantom wallet on devnet with ~3.27 SOL
- One existing shielded position from 1/26/2026

## Bugs Fixed Previously
- Duplicate USDC card ‚Äî removed USDC from SUPPORTED_TOKENS
- Repeated signature popups ‚Äî useRef boolean guard in useWallet.ts
- Supabase 406 error ‚Äî non-critical, handled gracefully

## Next Session
Start V5 implementation. Read `docs/plans/v5-dual-dex-swap-design.md` and this context file, then begin with step 1 (install Raydium SDK).
