# Context Snapshot - WhaleVault V4 Phase A + Cloud Sync Debugging
**Date:** 2026-01-28 04:45
**Context Usage:** Over threshold

## Current Task
Implementing V4 Phase A (mock pool data) and fixing critical cloud sync / wallet connection bugs introduced during the session.

## What Was Accomplished (V4 Phase A)

### Mock Pool Data — DONE
- `backend/config.py` — Added `mock_pool_data: bool = True` setting
- `backend/services/pool_service.py` — `get_all_pools()` returns mock stats when flag is on (47/32/12/5/2 deposits across 1/10/100/1K/10K SOL pools + 8 custom)
- `frontend/hooks/usePools.ts` — `NEXT_PUBLIC_MOCK_POOLS=true` env flag skips API, uses same mock data
- `frontend/.env.local` — `NEXT_PUBLIC_MOCK_POOLS=true` added
- `backend/.env` — `MOCK_POOL_DATA=true` added

### AnonymityBadge Component — DONE
- `frontend/components/shield/AnonymityBadge.tsx` — NEW component showing qualitative privacy labels (Strong/Good/Moderate/Low) with colored dots — NO exact deposit counts shown (privacy best practice)
- `frontend/components/shield/DenominationSelector.tsx` — Updated to use AnonymityBadge, added segmented control (Fixed Pools / Custom Amount tabs), low-privacy warning for pools with <5 deposits

## Critical Bugs Introduced (NEED FIXING)

### Bug 1: Wallet Connection Crash
**Status:** BROKEN — wallet cannot connect at all
**Error:** `WalletConnectionError: Unexpected error` at `StandardWalletAdapter._StandardWalletAdapter_connect`
**Root Cause:** Multiple iterations of the cloud sync trigger in `useWallet.ts` have destabilized the hook. The wallet adapter crashes during connect.
**Console shows:** Multiple `WalletConnectionError: Unexpected error` and `Error: Something went wrong` from `solanaActionsContentScript`

### Bug 2: Cloud Sync Not Loading Supabase Data
**Status:** BROKEN — 1 SOL position from Supabase never appears
**Root Cause (found by debugger agent):** Two competing localStorage systems:
- `whalevault-positions` (hyphen) — Zustand persist key
- `whalevault_positions` (underscore) — Legacy manual reads in unshield/private-swap pages
The legacy reads overwrote the Zustand store with stale data. **We removed the legacy reads** but cloud sync still doesn't work.

### Bug 3: Signature Popup Spam
**Status:** Was fixed but may be broken again due to wallet crash
**Original issue:** `initCloudSync` auto-fired on every page load/navigation, prompting wallet signature
**Fix applied:** Signature cached in sessionStorage (`wv_enc_sig` key) via `lib/encryption.ts`

## Key Files Modified This Session

### Backend
- `backend/config.py` — Added `mock_pool_data: bool = True`
- `backend/services/pool_service.py` — Added `_get_mock_pools()` static method, mock guard in `get_all_pools()`

### Frontend - V4 Phase A (clean, working)
- `frontend/hooks/usePools.ts` — Mock pools with env flag
- `frontend/components/shield/AnonymityBadge.tsx` — NEW, qualitative privacy labels
- `frontend/components/shield/DenominationSelector.tsx` — Uses AnonymityBadge, segmented control UI (user modified)

### Frontend - Cloud Sync (BUGGY, needs revert/rewrite)
- `frontend/hooks/useWallet.ts` — **HEAVILY MODIFIED, BROKEN** — went through ~6 iterations trying to fix cloud sync timing. Current state has module-level `_syncAttempted` flag, ref guard, removed reactive store subscription. Still crashing wallet.
- `frontend/stores/positions.ts` — Added `_hydrated: boolean` field, `onRehydrateStorage` callback, `clearCachedSignature()` in `clearCloudState`
- `frontend/lib/encryption.ts` — Added sessionStorage caching (`getCachedSignature`, `cacheSignature`, `clearCachedSignature`), `signEncryptionMessage` checks cache first
- `frontend/app/unshield/page.tsx` — Removed legacy `STORAGE_KEY` localStorage read, removed `setPositions` from destructure
- `frontend/app/private-swap/page.tsx` — Same removals as unshield

## What Needs To Happen Next

### Priority 1: Fix Wallet Connection (CRITICAL)
The wallet adapter is crashing. Need to revert `useWallet.ts` to a stable state where the wallet can connect. The V3 version of this file worked — compare with git.

### Priority 2: Fix Cloud Sync
After wallet works, fix cloud sync properly:
1. Signature should prompt ONCE on first connect (not on auto-reconnect/refresh)
2. Cached signature in sessionStorage avoids re-prompting
3. Cloud data from Supabase must merge with local positions
4. Must not overwrite store with stale data (legacy localStorage reads are already removed)

### Priority 3: Verify V4 Phase A Mock Data
Once wallet + cloud sync work, verify mock pool data shows in denomination selector.

## Architecture Decisions Made
1. **Pool deposit counts show qualitative labels** (Strong/Good/Moderate/Low) not exact numbers — privacy best practice
2. **Mock data matches V3 denominations** (1/10/100/1K/10K SOL) not the outdated V4 plan (0.1/1/10)
3. **Signature caching in sessionStorage** — survives refresh, cleared on tab close
4. **Zustand persist is the single source of truth** for positions — no legacy localStorage reads

## V4 Plan Location
- Full plan: `/Users/MAC/.claude/plans/velvet-tinkering-treehouse.md`
- Phase B (seeding): `docs/plans/v4-phase-b-seeding.md`

## Git State
- Branch: `main`
- Last commit: V3 (`5433d17`)
- All V4 Phase A changes are uncommitted
- Many files modified — run `git diff` to see full scope

## Important: How To Recover
1. `git stash` the current state to save work
2. `git checkout -- frontend/hooks/useWallet.ts` to revert the broken file
3. Re-apply ONLY the clean changes (mock pools, AnonymityBadge, encryption caching)
4. Carefully re-implement cloud sync with proper testing

OR: Use `git diff frontend/hooks/useWallet.ts` to see all changes and surgically fix the broken parts.
