# Context Snapshot - Bug Fix Session (Wallet + Cloud Sync + Encryption)
**Date:** 2026-01-28 04:55
**Context Usage:** Over threshold

## Current Task
Fixing 3 bugs: wallet connection crash, cloud sync not loading, encryption cache not wallet-specific.

## What Was Done This Session

### Fix 1: Cloud sync effect race condition (useWallet.ts)
- Removed `signMessage` from effect dependency array
- Added 100ms setTimeout defer before calling initCloudSync
- Added cleanup return for the timeout

### Fix 2: Supabase error swallowed (positions.ts)
- Changed `const { data }` to `const { data, error: fetchError }`
- Added PGRST116 (no rows) handling — silences expected "first time" case
- Logs real Supabase errors

### Fix 3: Wallet-specific signature cache (encryption.ts)
- Cache key changed from fixed `wv_enc_sig` to `wv_enc_sig_<publicKey>`
- `signEncryptionMessage` now takes `publicKey` param
- `clearCachedSignature()` with no args clears ALL cached sigs (disconnect)
- `clearCachedSignature(pubkey)` clears specific wallet's cache

### Fix 4 (REVERTED): Removed manual wallet adapters from WalletProvider
- Removed PhantomWalletAdapter, SolflareWalletAdapter, TorusWalletAdapter
- This BROKE things worse — autoConnect crashed trying to reconnect stale adapter
- REVERTED back to V3 version with manual adapters

## Current Bug Status
- **Wallet connection:** STILL BROKEN — `WalletConnectionError: Unexpected error` on autoConnect
- **Cloud sync:** Fix applied but untestable until wallet connects
- **Encryption cache:** Fix applied but untestable until wallet connects

## Root Cause Analysis
The `autoConnect` prop on `SolanaWalletProvider` tries to reconnect the previously selected wallet on page load. The localStorage has a stale wallet name (possibly from when we briefly removed adapters). The autoConnect fires and crashes.

The cloud sync effect may also be interfering — it fires immediately when `connected` becomes true, potentially calling `signMessage` before the adapter is fully ready even with the 100ms defer.

## Possible Next Steps
1. Try disabling `autoConnect` temporarily to test manual connect
2. Clear localStorage wallet-name entry to remove stale reference
3. Make cloud sync completely lazy — only trigger on user action, not on connect
4. Increase defer timeout significantly (500ms+)

## Files Modified
- `frontend/hooks/useWallet.ts` — Cloud sync defer + dep array fix
- `frontend/stores/positions.ts` — Supabase error handling + publicKey param
- `frontend/lib/encryption.ts` — Wallet-specific cache keys
- `frontend/components/wallet/WalletProvider.tsx` — REVERTED to V3

## Git State
- Branch: main, last commit: 5433d17
- All changes uncommitted
