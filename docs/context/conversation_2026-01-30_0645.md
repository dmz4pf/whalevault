# Context Snapshot - WhaleVault Private Swap Fix
**Date:** 2026-01-30 06:45
**Commit:** aabdcd4

## Current Task
Fix private swap to work with Raydium's API limitation - `outputAccount` must be owned by signer.

## Root Cause (Confirmed)
- Raydium API returns `REQ_OWNER_ACCOUNT_ERROR`
- `outputAccount` parameter must be owned by the `wallet` (signer)
- Cannot route tokens directly to recipient's ATA in single swap

## Approved Solution: Two-Transaction Approach
1. **Swap TX**: SOL → Token (tokens land in relayer's ATA)
2. **Transfer TX**: SPL transfer from relayer's ATA → recipient's ATA

## Files to Modify
1. `backend/services/raydium_service.py` - Remove `recipient_public_key` param, remove `outputAccount`
2. `backend/api/routes/swap.py` - Add `transfer_tokens_to_recipient()`, add `send_sol_to_recipient()` fallback

## Key Implementation Details
- Remove `outputAccount` from Raydium API request (defaults to wallet's ATA)
- Add SPL transfer instruction after swap confirms
- Retry transfer 3x before failing
- If swap fails: send SOL directly to recipient as fallback
- If transfer fails: log for manual recovery

## Privacy Flow
```
User → Shield → Privacy Pool → Relayer (unshield) → Relayer (swap) → Relayer (transfer) → Recipient
```
No swap touches user wallet. Relayer handles all post-unshield operations.

## Required Imports
```python
from spl.token.instructions import transfer, TransferParams
from spl.token.constants import TOKEN_PROGRAM_ID
from solders.message import MessageV0
from solders.system_program import transfer as sol_transfer
```

## Plan File
`/Users/MAC/.claude/plans/async-drifting-garden.md`

## Next Steps
1. Modify `raydium_service.py` - remove recipient param and outputAccount
2. Add helper functions to `swap.py`
3. Update `execute_swap_devnet()` with two-transaction flow
4. Test on devnet
